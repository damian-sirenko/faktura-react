// –§–∞–π–ª: src/pages/ClientsPage.jsx
import React, { useState, useEffect, useMemo, useRef } from "react";
import ClientList from "../components/clients/ClientList";
import ClientCard from "../components/clients/ClientCard";
import * as XLSX from "xlsx";
import Modal from "../components/ui/Modal";
import { jsPDF } from "jspdf";
import { apiFetch, api } from "../utils/api";

// ‚ñº –î–æ–≤—ñ–¥–Ω–∏–∫ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ñ–≤ (–Ω–∞–∑–≤–∏ –º–∞—é—Ç—å –∑–±—ñ–≥–∞—Ç–∏—Å—è –∑ —Ç–∏–º, —â–æ —É –≤–∞—Å —É –±–∞–∑—ñ)
const SUBSCRIPTIONS = [
  "STERYL 20",
  "STERYL 30",
  "STERYL 50",
  "STERYL 100",
  "STERYL 150",
  "STERYL 200",
  "STERYL 300",
  "STERYL 500",
];

// ‚ñº Kategorie logistyki klienta
const LOGI_OPTIONS = [
  { value: "punkt", label: "Dostarcza do punktu" },
  { value: "paczkomat", label: "Wysy≈Ça paczkomatem" },
  { value: "kurier", label: "Wymaga dojazdu kuriera" },
];
const LOGI_LABEL = {
  punkt: "Dostarcza do punktu",
  paczkomat: "Wysy≈Ça paczkomatem",
  kurier: "Wymaga dojazdu kuriera",
};

// --- helpers ---
function addMonths(dateStr, monthsToAdd) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  if (Number.isNaN(d.getTime())) return "";
  d.setMonth(d.getMonth() + monthsToAdd);
  return d.toISOString().split("T")[0];
}
function normalizeExcelDate(val) {
  if (!val && val !== 0) return "";
  if (typeof val === "number") {
    try {
      if (XLSX?.SSF?.parse_date_code) {
        const p = XLSX.SSF.parse_date_code(val);
        if (p && p.y && p.m && p.d) {
          const dt = new Date(Date.UTC(p.y, p.m - 1, p.d));
          if (!Number.isNaN(dt.getTime()))
            return dt.toISOString().split("T")[0];
        }
      }
    } catch {}
  }
  if (val instanceof Date && !Number.isNaN(val.getTime())) {
    return val.toISOString().split("T")[0];
  }
  const s = String(val).trim();
  if (!s) return "";
  const asDate = new Date(s);
  if (!Number.isNaN(asDate.getTime()))
    return asDate.toISOString().split("T")[0];
  const m = s.match(/^(\d{1,2})[./-](\d{1,2})[./-](\d{4})$/);
  if (m) {
    const day = parseInt(m[1], 10);
    const month = parseInt(m[2], 10) - 1;
    const year = parseInt(m[3], 10);
    const dt = new Date(Date.UTC(year, month, day));
    if (!Number.isNaN(dt.getTime())) return dt.toISOString().split("T")[0];
  }
  return "";
}
function endOfNextMonthISO(from = new Date()) {
  const d = new Date(from);
  d.setUTCDate(1);
  d.setUTCMonth(d.getUTCMonth() + 2);
  d.setUTCDate(0);
  return d.toISOString().split("T")[0];
}
function pick(row, keys) {
  for (const k of keys) {
    if (row?.[k] != null && String(row[k]).trim() !== "") return row[k];
  }
  const map = {};
  Object.keys(row || {}).forEach((k) => {
    map[k.trim().toLowerCase()] = row[k];
  });
  for (const k of keys) {
    const v = map[k.trim().toLowerCase()];
    if (v != null && String(v).trim() !== "") return v;
  }
  return "";
}
const todayISO = () => new Date().toISOString().slice(0, 10);
// === bool parser: true/1/"true"/"1"/"yes"/"tak" -> true
function boolish(v) {
  if (typeof v === "boolean") return v;
  if (typeof v === "number") return v === 1;
  const s = String(v ?? "")
    .trim()
    .toLowerCase();
  return (
    s === "1" ||
    s === "true" ||
    s === "yes" ||
    s === "y" ||
    s === "tak" ||
    s === "t"
  );
}

// [INSERT NEAR OTHER HELPERS]

// fetch -> base64 –¥–ª—è jsPDF VFS
async function __toBase64FromUrl(url) {
  const r = await fetch(url);
  const buf = await r.arrayBuffer();
  let binary = "";
  const bytes = new Uint8Array(buf);
  for (let i = 0; i < bytes.length; i++)
    binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

// –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —à—Ä–∏—Ñ—Ç—ñ–≤ DejaVu –≤ –µ–∫–∑–µ–º–ø–ª—è—Ä—ñ jsPDF
async function __registerDejaVuFonts(doc) {
  try {
    const fonts = doc.getFontList ? doc.getFontList() : {};
    if (fonts && fonts["DejaVuSans"]) return; // –≤–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ

    const regular = await __toBase64FromUrl("/fonts/DejaVuSans.ttf");
    const bold = await __toBase64FromUrl("/fonts/DejaVuSans-Bold.ttf");

    doc.addFileToVFS("DejaVuSans.ttf", regular);
    doc.addFont("DejaVuSans.ttf", "DejaVuSans", "normal");

    doc.addFileToVFS("DejaVuSans-Bold.ttf", bold);
    doc.addFont("DejaVuSans-Bold.ttf", "DejaVuSans", "bold");
  } catch (e) {
    console.error("Nie uda≈Ço siƒô wczytaƒá font√≥w DejaVu:", e);
  }
}

/* ===== helper –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è ZIP –∑ POST ===== */
async function postForDownload(url, payload, fallbackName = "faktury.zip") {
  const r = await fetch(api(url), {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  const ct = (r.headers.get("content-type") || "").toLowerCase();
  const disp = r.headers.get("content-disposition") || "";

  if (!r.ok) {
    let msg = "B≈ÇƒÖd generowania";
    try {
      msg = ct.includes("application/json")
        ? (await r.json())?.error || msg
        : await r.text();
    } catch {}
    throw new Error(msg);
  }

  const looksLikeFile =
    ct.includes("application/zip") ||
    ct.includes("application/octet-stream") ||
    ct.includes("binary") ||
    /attachment/i.test(disp);

  if (looksLikeFile) {
    const blob = await r.blob();
    const urlObj = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = urlObj;
    const m = /filename="([^"]+)"/i.exec(disp);
    a.download = m ? m[1] : fallbackName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(urlObj);
    return true;
  }

  const data = await r.json().catch(() => null);
  if (data?.error) throw new Error(data.error);
  return data;
}

/* === –°—Ç–∞–±—ñ–ª—å–Ω—ñ ID === */
const slugify = (s) =>
  String(s || "")
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");

// –¥–æ–ø–æ–º—ñ–∂–Ω–æ: —Å—Ç–∞–±—ñ–ª—å–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∞
const getId = (c) => {
  const raw =
    c?.id ??
    c?.ID ??
    c?.Id ??
    c?.iD ??
    c?.["Id"] ??
    c?.["ID "] ??
    c?.[" id"] ??
    "";
  const id = String(raw).trim();
  if (id) return id;
  const name = String(c?.name ?? c?.Klient ?? "").trim();
  return slugify(name);
};

function idNumericValue(c) {
  const raw = getId(c);
  const m = String(raw).match(/(\d+)/);
  if (!m) return Number.POSITIVE_INFINITY;
  return parseInt(m[1], 10);
}

const sameClient = (a, b) => {
  if (a === b) return true;
  const ida = getId(a);
  const idb = getId(b);
  return ida && idb && ida === idb;
};

export default function ClientsPage({
  forcedMode = "abonament", // 'abonament' | 'perpiece' | 'all'
  hideModeSwitcher = false,
  forceArchivedView = false,
  pageTitle,
} = {}) {
  const [clients, setClients] = useState([]);
  const [selectedClient, setSelectedClient] = useState(null);
  const [scrollYBeforeOpen, setScrollYBeforeOpen] = useState(0);

  const [confirmOpen, setConfirmOpen] = useState(false);
  const [clientToDelete, setClientToDelete] = useState(null);

  const [q, setQ] = useState("");
  const [tab, setTab] = useState(
    forcedMode === "perpiece" ? "perpiece" : "abonament"
  );

  const [abonFilter, setAbonFilter] = useState("");

  const [showAdd, setShowAdd] = useState(false);
  const [editIndex, setEditIndex] = useState(null);

  const [addedInfo, setAddedInfo] = useState({ open: false, name: "" });
  // –ø—Ä–æ–≥—Ä–µ—Å –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó (–æ–≤–µ—Ä–ª–µ–π —ñ–∑ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä–æ–º)
  const [genProgress, setGenProgress] = useState({
    open: false,
    pct: 0,
    text: "",
  });
  const genProgTimerRef = useRef(null);

  // ‚ñº –º—É–ª—å—Ç–∏–≤–∏–±—ñ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑ –±–∞–∑–∏
  const [checkedIds, setCheckedIds] = useState([]);

  // ‚ñº –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è (—â–æ–± –ø—ñ–¥—Å—Ç–∞–≤–∏—Ç–∏ –º—ñ—Å—è—Ü—å —É –º–æ–¥–∞–ª—Ü—ñ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó)
  const [settings, setSettings] = useState({
    currentIssueMonth: new Date().toISOString().slice(0, 7),
  });

  const [genModal, setGenModal] = useState({
    open: false,
    issueDate: todayISO(),
    month: new Date().toISOString().slice(0, 7),
  });

  // ‚úÖ –ü–ï–†–ï–ú–ò–ö–ê–ß –°–ü–ò–°–ö–£: –ê–∫—Ç–∏–≤–Ω—ñ / –ê—Ä—Ö—ñ–≤
  const [showArchived, setShowArchived] = useState(
    forceArchivedView ? true : false
  );

  // ‚úÖ –ü—Ä–æ—Ç–æ–∫–æ–ª–∏ –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞ (read-only —Å–ø–∏—Å–æ–∫)
  const [clientProtocols, setClientProtocols] = useState({
    loading: false,
    list: [],
  });

  const emptyClient = {
    id: "",
    name: "",
    address: "",
    type: "op",
    nip: "",
    pesel: "",
    email: "",
    phone: "",
    agreementStart: "",
    agreementEnd: "",
    subscription: "",
    subscriptionAmount: "",
    notice: false,
    comment: "",
    billingMode: "abonament",
    logistics: "kurier", // 'punkt' | 'paczkomat' | 'kurier' (wymagane)
    // —ñ–Ω–¥–∏–≤—ñ–¥—É–∞–ª—å–Ω—ñ —Ü—ñ–Ω–∏ (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≥–ª–æ–±–∞–ª—å–Ω—ñ)
    courierPriceMode: "global",
    courierPriceGross: null,
    shippingPriceMode: "global",
    shippingPriceGross: null,
    // ‚úÖ –Ω–æ–≤–µ: –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—è
    archived: false,
  };
  const [formClient, setFormClient] = useState(emptyClient);

  // load settings
  useEffect(() => {
    (async () => {
      try {
        const r = await apiFetch("/settings");
        if (r.ok) {
          const s = await r.json();
          setSettings((prev) => ({
            ...prev,
            currentIssueMonth:
              typeof s.currentIssueMonth === "string" &&
              /^\d{4}-\d{2}$/.test(s.currentIssueMonth)
                ? s.currentIssueMonth
                : prev.currentIssueMonth,
          }));
          // —è–∫—â–æ –º–æ–¥–∞–ª–∫–∞ —â–µ –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–∞ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –¥–µ—Ñ–æ–ª—Ç
          setGenModal((g) =>
            g.open ? g : { ...g, month: s.currentIssueMonth || g.month }
          );
        }
      } catch {}
    })();
  }, []);

  // load clients
  useEffect(() => {
    apiFetch("/clients")
      .then((res) => res.json())
      .then((data) => {
        const arr = Array.isArray(data) ? data : [];
        const normalized = arr.map((r) => {
          const startISO = normalizeExcelDate(
            r.agreementStart ??
              r["Data podpisania umowy"] ??
              r.agreementSign ??
              ""
          );

          const idRaw =
            r.id ??
            r.ID ??
            r.Id ??
            r.iD ??
            r["Id"] ??
            r["ID "] ??
            r[" id"] ??
            "";
          const nameVal = String(r.name || r.Klient || "").trim();
          const finalId = String(idRaw || "").trim() || slugify(nameVal);

          const hasAbon = !!String(
            r.subscription ?? r.Abonament ?? r.abonament ?? ""
          ).trim();
          const billingMode =
            r.billingMode || (hasAbon ? "abonament" : "perpiece");

          const endISO = normalizeExcelDate(
            r.agreementEnd ?? r["ObowiƒÖzuje do"] ?? r.end ?? ""
          );

          const courierPriceMode =
            r.courierPriceMode === "custom" ? "custom" : "global";
          const shippingPriceMode =
            r.shippingPriceMode === "custom" ? "custom" : "global";

          const courierPriceGross =
            r.courierPriceGross != null
              ? Number(r.courierPriceGross)
              : r["courierPriceGross"] != null
              ? Number(r["courierPriceGross"])
              : null;

          const shippingPriceGross =
            r.shippingPriceGross != null
              ? Number(r.shippingPriceGross)
              : r["shippingPriceGross"] != null
              ? Number(r["shippingPriceGross"])
              : null;

          return {
            // ‚ñ∫ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—è
            archived: boolish(r.archived),
            archivedAt:
              r.archivedAt ||
              r.archived_at ||
              r.archiveDate ||
              r.archiwizacja ||
              r.updatedAt ||
              "",

            id: finalId,
            name: r.name || r.Klient || "",
            address: r.address || r.Adres || "",
            type:
              (r.type || r["Firma - OP"] || "op").toLowerCase() === "firma"
                ? "firma"
                : "op",
            nip: r.nip || r.NIP || "",
            pesel: r.pesel || r.Pesel || "",
            email: r.email ?? r.Email ?? "",
            phone: r.phone ?? r.Telefon ?? "",
            agreementStart: startISO,
            agreementEnd: endISO || (startISO ? addMonths(startISO, 6) : ""),
            subscription: r.subscription ?? r.Abonament ?? r.abonament ?? "",
            subscriptionAmount: Number(
              r.subscriptionAmount ??
                r["Kwota abonamentu"] ??
                r.abonamentAmount ??
                0
            ),
            notice: Boolean(r.notice),
            comment: r.comment ?? "",
            billingMode,
            logistics: (() => {
              const raw =
                r.logistics ??
                r.deliveryMode ??
                r.transport ??
                r["logistyka"] ??
                r["Transport"] ??
                "";
              const v = String(raw || "")
                .toLowerCase()
                .trim();
              if (v === "punkt" || /punkt/.test(v)) return "punkt";
              if (v === "paczkomat" || /paczko/.test(v)) return "paczkomat";
              if (v === "kurier" || /kurier|dojazd/.test(v)) return "kurier";
              return "kurier";
            })(),
            courierPriceMode,
            courierPriceGross,
            shippingPriceMode,
            shippingPriceGross,
          };
        });
        setClients(normalized);
      })
      .catch(() => {});
  }, []);

  // —ñ–º–ø–æ—Ä—Ç Excel –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏
  const handleFileUpload = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(sheet);

        const mapped = rows
          .filter(
            (r) =>
              pick(r, ["Klient", "client", "nazwa"]) ||
              pick(r, ["ID", "Id", "id"])
          )
          .map((r) => {
            const idFromId = pick(r, ["ID", "Id", "id", "ID ", " id"]);
            const name = String(
              pick(r, ["Klient", "client", "nazwa"]) || ""
            ).trim();
            const id = String(idFromId || name).trim() || slugify(name);
            const startISO = normalizeExcelDate(
              pick(r, ["Data podpisania umowy", "agreementStart", "start"])
            );
            const endISO = normalizeExcelDate(
              pick(r, ["ObowiƒÖzuje do", "agreementEnd", "end"])
            );
            return {
              id,
              name,
              address: pick(r, ["Adres", "address", "adres"]),
              type:
                String(pick(r, ["Firma - OP", "type"]) || "")
                  .toLowerCase()
                  .trim() === "firma"
                  ? "firma"
                  : "op",
              nip: pick(r, ["NIP", "nip"]),
              pesel: pick(r, ["Pesel", "PESEL", "pesel"]),
              email: pick(r, ["Email", "email"]),
              phone: pick(r, ["Telefon", "phone", "telefon"]),
              agreementStart: startISO,
              agreementEnd: endISO || (startISO ? addMonths(startISO, 6) : ""),
              subscription: pick(r, ["Abonament", "subscription", "abonament"]),
              subscriptionAmount: Number(
                pick(r, ["Kwota abonamentu", "subscriptionAmount"]) || 0
              ),
              notice: false,
              comment: "",
              billingMode: tab,
              logistics: (() => {
                const raw =
                  pick(r, [
                    "logistics",
                    "logistyka",
                    "transport",
                    "Transport",
                  ]) || "";
                const v = String(raw || "")
                  .toLowerCase()
                  .trim();
                if (v === "punkt" || /punkt/.test(v)) return "punkt";
                if (v === "paczkomat" || /paczko/.test(v)) return "paczkomat";
                if (v === "kurier" || /kurier|dojazd/.test(v)) return "kurier";
                return "kurier";
              })(),
              // –Ω–æ–≤—ñ –ø–æ–ª—è –∑–∞–ª–∏—à–∞—î–º–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º (global)
              courierPriceMode: "global",
              courierPriceGross: null,
              shippingPriceMode: "global",
              shippingPriceGross: null,
              // ‚úÖ –ø—Ä–∏ —ñ–º–ø–æ—Ä—Ç—ñ ‚Äî –∞–∫—Ç–∏–≤–Ω–∏–π, –Ω–µ –∞—Ä—Ö—ñ–≤
              archived: false,
            };
          });

        const next = [...clients, ...mapped];
        setClients(next);
        fetch(api("/save-clients"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(next),
        }).catch(() => {});
      } catch {}
    };
    reader.readAsArrayBuffer(file);
    e.target.value = "";
  };

  // –¥–æ–¥–∞—Ç–∏/—Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏
  const startAdd = () => {
    if (showAdd) {
      setShowAdd(false);
      setEditIndex(null);
      setFormClient({ ...emptyClient, billingMode: tab });
      return;
    }
    setEditIndex(null);
    setFormClient({ ...emptyClient, billingMode: tab });
    setShowAdd(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  };
  const startEdit = (client) => {
    const idxByRef = clients.findIndex((c) => c === client);
    let idx = idxByRef;
    if (idx === -1) {
      const id = getId(client);
      idx = clients.findIndex((c) => getId(c) === id);
    }
    // –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ –¥–µ—Ñ–æ–ª—Ç –ª–æ–≥—ñ—Å—Ç–∏–∫–∏ –ø—Ä–∏ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—ñ —Å—Ç–∞—Ä–∏—Ö –∑–∞–ø–∏—Å—ñ–≤
    const withDefaultLogi = {
      ...client,
      logistics: client.logistics || "kurier",
    };
    setEditIndex(idx === -1 ? null : idx);
    setFormClient({
      ...withDefaultLogi,
      billingMode: client.billingMode || tab,
    });
    setShowAdd(true);
    window.scrollTo({ top: 0, behavior: "smooth" });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    const payload = { ...formClient };
    if (!payload.logistics) payload.logistics = "kurier";
    const startISO = normalizeExcelDate(payload.agreementStart);
    payload.agreementStart = startISO;
    payload.agreementEnd =
      normalizeExcelDate(payload.agreementEnd) ||
      (startISO ? addMonths(startISO, 6) : "");
    payload.subscriptionAmount = Number(payload.subscriptionAmount || 0);
    if (!payload.billingMode) payload.billingMode = tab;

    // ‚ö†Ô∏è –≥–∞—Ä–∞–Ω—Ç—É—î–º–æ —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π id
    if (!payload.id?.trim()) {
      payload.id = slugify(payload.name);
    }

    // ‚úÖ –Ω–µ –¥–∞—î–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∞—Ä—Ö—ñ–≤–æ–≤–∞–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
    if (payload.archived == null) payload.archived = false;

    let updated = [...clients];
    if (editIndex !== null && editIndex >= 0) updated[editIndex] = payload;
    else updated.push(payload);

    setClients(updated);
    setShowAdd(false);
    setEditIndex(null);
    setFormClient({ ...emptyClient, billingMode: tab });

    try {
      await apiFetch("/save-clients", {
        method: "POST",
        json: updated,
      });

      if (editIndex === null)
        setAddedInfo({ open: true, name: payload.name || "" });
    } catch {
      alert("Nie uda≈Ço siƒô zapisaƒá zmian.");
    }
  };

  const handleSetNotice = async (client) => {
    let idx = clients.findIndex((c) => sameClient(c, client));
    if (idx === -1) return;
    const updated = [...clients];
    const newClient = {
      ...updated[idx],
      agreementEnd: endOfNextMonthISO(new Date()),
      notice: true,
    };
    updated[idx] = newClient;
    setClients(updated);
    setSelectedClient(newClient);
    try {
      await fetch(api("/save-clients"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updated),
      });
    } catch {
      alert("Nie uda≈Ço siƒô zapisaƒá zmian.");
    }
  };

  const handleCancelNotice = async (client) => {
    let idx = clients.findIndex((c) => sameClient(c, client));
    if (idx === -1) return;
    const updated = [...clients];
    const startISO = updated[idx].agreementStart || "";
    const backToEnd = startISO ? addMonths(startISO, 6) : "";
    const newClient = {
      ...updated[idx],
      notice: false,
      agreementEnd: backToEnd,
    };
    updated[idx] = newClient;
    setClients(updated);
    setSelectedClient(newClient);
    try {
      await fetch(api("/save-clients"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updated),
      });
    } catch {}
  };

  const handleUpdateClient = async (nextClient) => {
    let idx = clients.findIndex((c) => sameClient(c, selectedClient));
    if (idx === -1) {
      // –æ—Å—Ç–∞–Ω–Ω—è —Å–ø—Ä–æ–±–∞ ‚Äî –ø–æ id –∑ nextClient
      const nid = getId(nextClient);
      idx = clients.findIndex((c) => getId(c) === nid);
    }
    if (idx === -1) return;
    const updated = [...clients];
    updated[idx] = nextClient;
    setClients(updated);
    setSelectedClient(nextClient);
    try {
      await fetch(api("/save-clients"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updated),
      });
    } catch {}
  };

  // ‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ç–æ–∫–æ–ª—ñ–≤ –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
  useEffect(() => {
    const loadProtocols = async (clientObj) => {
      if (!clientObj) {
        setClientProtocols({ loading: false, list: [] });
        return;
      }
      setClientProtocols({ loading: true, list: [] });
      try {
        const r = await fetch(api("/protocols"), { cache: "no-store" });
        const all = r.ok ? await r.json() : [];
        const id = getId(clientObj);
        const name = String(clientObj.name || clientObj.Klient || "")
          .trim()
          .toLowerCase();
        const filtered = (all || []).filter(
          (p) =>
            String(p.id || "").trim() === id ||
            String(p.clientName || "")
              .trim()
              .toLowerCase() === name
        );
        setClientProtocols({ loading: false, list: filtered });
      } catch {
        setClientProtocols({ loading: false, list: [] });
      }
    };
    loadProtocols(selectedClient);
  }, [selectedClient]);

  const filtered = useMemo(() => {
    const s = q.trim().toLowerCase();

    // 1) –±–∞–∑–æ–≤–∏–π –Ω–∞–±—ñ—Ä –ø–æ —Ä–µ–∂–∏–º—É (abonament/perpiece/all)
    const base =
      forcedMode === "all"
        ? clients
        : clients.filter((c) => (c.billingMode || "abonament") === tab);

    // 2) –∞—Ä—Ö—ñ–≤ —á–∏ –Ω—ñ
    const byArchive = base.filter((c) =>
      forceArchivedView
        ? Boolean(c.archived)
        : showArchived
        ? Boolean(c.archived)
        : !Boolean(c.archived)
    );

    // 3) —è–∫—â–æ –º–∏ —É –≤–∫–ª–∞–¥—Ü—ñ abonament ‚Äî –¥–æ–¥–∞—Ç–∫–æ–≤–∏–π —Ñ—ñ–ª—å—Ç—Ä –ø–æ –Ω–∞–∑–≤—ñ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—É
    const byAbon =
      forcedMode === "abonament" ||
      (forcedMode !== "perpiece" && tab === "abonament")
        ? byArchive.filter((c) =>
            abonFilter.trim()
              ? String(c.subscription || "")
                  .toLowerCase()
                  .includes(abonFilter.trim().toLowerCase())
              : true
          )
        : byArchive;

    // 4) –ø–æ—à—É–∫ –ø–æ —ñ–º–µ–Ω—ñ
    const afterSearch = s
      ? byAbon.filter((c) => (c.name || "").toLowerCase().includes(s))
      : byAbon;

    // 5) –°–û–†–¢–£–í–ê–ù–ù–Ø:
    //    —è–∫—â–æ —Ü–µ "na sztuki" (perpiece), —Å–æ—Ä—Ç—É—î–º–æ –∑–∞ —á–∏—Å–ª–æ–≤–∏–º –∑–Ω–∞—á–µ–Ω–Ω—è–º id –∑—Ä–æ—Å—Ç–∞—é—á–µ
    const isPerPieceView =
      forcedMode === "perpiece" ||
      (forcedMode !== "abonament" && tab === "perpiece");

    if (isPerPieceView) {
      const sorted = [...afterSearch].sort((a, b) => {
        const na = idNumericValue(a);
        const nb = idNumericValue(b);
        if (na !== nb) return na - nb;
        return (a.name || "").localeCompare(b.name || "", "pl", {
          sensitivity: "base",
          numeric: true,
        });
      });
      return sorted;
    }

    return afterSearch;
  }, [
    q,
    clients,
    tab,
    abonFilter,
    showArchived,
    forcedMode,
    forceArchivedView,
  ]);

  // ‚ñ∫ –ó–∞–º—ñ—Å—Ç—å –≤–∏–¥–∞–ª–µ–Ω–Ω—è ‚Äî –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—è (–æ–¥–∏–Ω)
  const askDelete = (client) => {
    setClientToDelete(client);
    setConfirmOpen(true);
  };
  const confirmDelete = async () => {
    if (!clientToDelete) return;
    const delId = getId(clientToDelete);
    const today = new Date().toISOString().slice(0, 10);
    const updated = clients.map((c) =>
      getId(c) === delId ? { ...c, archived: true, archivedAt: today } : c
    );
    setClients(updated);
    setConfirmOpen(false);
    setClientToDelete(null);
    try {
      await fetch(api("/save-clients"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updated),
      });
    } catch {
      alert("Nie uda≈Ço siƒô zapisaƒá zmian.");
    }
  };

  // ‚ñ∫ –ø–µ—Ä–µ–º–∏–∫–∞—á –≤–∫–ª–∞–¥–æ–∫
  const switchTab = (t) => {
    setTab(t);
    setSelectedClient(null);
    setShowAdd(false);
    setEditIndex(null);
    setCheckedIds([]);
  };

  // ‚ñ∫ –º—É–ª—å—Ç–∏–≤–∏–±—ñ—Ä
  const onToggleCheck = (id, checked) => {
    setCheckedIds((prev) =>
      checked
        ? Array.from(new Set([...prev, id]))
        : prev.filter((x) => x !== id)
    );
  };
  const onToggleCheckAll = (idsOnPage, checked) => {
    setCheckedIds((prev) => {
      if (checked) return Array.from(new Set([...prev, ...idsOnPage]));
      return prev.filter((id) => !idsOnPage.includes(id));
    });
  };

  // ‚ñ∫ –≥—Ä—É–ø–æ–≤–∞ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—è (–∑–∞–º—ñ—Å—Ç—å –≤–∏–¥–∞–ª–µ–Ω–Ω—è)
  const bulkDelete = async () => {
    if (!checkedIds.length) {
      alert("Zaznacz klient√≥w do archiwizacji.");
      return;
    }
    if (!confirm("Przenie≈õƒá zaznaczonych klient√≥w do archiwum?")) return;
    const today = new Date().toISOString().slice(0, 10);
    const updated = clients.map((c) =>
      checkedIds.includes(getId(c))
        ? { ...c, archived: true, archivedAt: today }
        : c
    );

    setClients(updated);
    setCheckedIds([]);
    try {
      await fetch(api("/save-clients"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updated),
      });
      alert("‚úÖ Przeniesiono do archiwum.");
    } catch {
      alert("‚ùå Nie uda≈Ço siƒô zapisaƒá zmian.");
    }
  };

  // ‚ñ∫ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑ –±–∞–∑–∏
  const openGen = () => {
    if (!checkedIds.length) {
      alert("Zaznacz klient√≥w.");
      return;
    }
    // —Å–∫–∏–¥–∞–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—É
    setGenProgress({ open: false, pct: 0, text: "" });

    setGenModal({
      open: true,
      issueDate: todayISO(),
      month:
        (typeof settings.currentIssueMonth === "string" &&
          /^\d{4}-\d{2}$/.test(settings.currentIssueMonth) &&
          settings.currentIssueMonth) ||
        new Date().toISOString().slice(0, 7),
    });
  };
  const openKartoteka = React.useCallback(() => {
    window.open(api("/clients/kartoteka.pdf"), "_blank", "noopener,noreferrer");
  }, []);

  // [REPLACE WHOLE FUNCTION generateLabelsPDF]
  const generateLabelsPDF = async () => {
    if (!checkedIds.length) {
      alert("Zaznacz klient√≥w.");
      return;
    }
    const picked = clients.filter((c) => checkedIds.includes(getId(c)));
    if (!picked.length) {
      alert("Brak wybranych klient√≥w.");
      return;
    }

    const doc = new jsPDF({
      orientation: "portrait",
      unit: "mm",
      format: "a4",
    });
    await __registerDejaVuFonts(doc);

    // –°—Ç–∞–ª—ñ
    const PAGE_W = 210;
    const PAGE_H = 297;

    const PAGE_MARGIN = 5; // –Ω–µ–≤–µ–ª–∏–∫–∏–π –∫—Ä–∞–π —Å—Ç–æ—Ä—ñ–Ω–∫–∏
    const GAP = 2; // 2 –º–º –º—ñ–∂ –µ—Ç–∏–∫–µ—Ç–∫–∞–º–∏
    const COLS = 3;
    const ROWS = 7;

    const ID_BAND_H = 10; // –≤–∏—â–∞ —Å–º—É–≥–∞ –¥–ª—è —Å—Ç–∞–±—ñ–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä—É–≤–∞–Ω–Ω—è
    const FONT_SIZE = 12;

    // –û–±–ª–∞—Å—Ç—å –≤–µ—Ä—Å—Ç–∫–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–æ–ª—ñ–≤
    const AREA_W = PAGE_W - PAGE_MARGIN * 2;
    const AREA_H = PAGE_H - PAGE_MARGIN * 2;

    // –†–æ–∑–º—ñ—Ä–∏ –∫–æ–º—ñ—Ä–æ–∫: 3√ó7
    const cellW = (AREA_W - GAP * (COLS - 1)) / COLS;
    const cellH = (AREA_H - GAP * (ROWS - 1)) / ROWS;

    // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–µ–∫—Å—Ç—É
    doc.setFont("DejaVuSans", "bold");
    doc.setFontSize(FONT_SIZE);
    doc.setLineWidth(0.2);

    // –¢–æ—á–Ω—ñ –º–µ—Ç—Ä–∏–∫–∏ —Ä—è–¥–∫–∞ –≤ –º–º (–±–µ–∑ –¥—É–±–ª—é–≤–∞–Ω—å)
    const mmPerPt = 0.352777778;
    const LHF =
      typeof doc.getLineHeightFactor === "function"
        ? doc.getLineHeightFactor()
        : 1.15;
    const lineH = FONT_SIZE * LHF * mmPerPt;

    // –ü–∞–¥–¥—ñ–Ω–≥–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–º—ñ—Ä–æ–∫
    const PAD_X = 1.5;
    const PAD_Y = 1.5;

    const labels = picked.map((c) => ({
      id: String(getId(c) || "").trim(),
      name: String(c.name || "").trim(),
    }));

    const perPage = COLS * ROWS;

    // –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —Ä–µ–Ω–¥–µ—Ä —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –±–ª–æ–∫—É –ø–æ —Ü–µ–Ω—Ç—Ä—É –æ—Å–µ—Ä–µ–¥–∫—É (–ø–æ X —ñ Y)
    function drawCenteredBlock(x0, top, width, height, text) {
      const availW = width - PAD_X * 2;

      let lines = doc.splitTextToSize(String(text || ""), availW);
      const maxLines = Math.max(1, Math.floor((height - PAD_Y * 2) / lineH));
      if (lines.length > maxLines) lines = lines.slice(0, maxLines);

      const blockH = Math.max(lineH, lines.length * lineH);
      const yStart = top + (height - blockH) / 2;

      doc.text(lines, x0 + width / 2, yStart, {
        align: "center",
        baseline: "top",
        maxWidth: availW,
      });
    }

    labels.forEach((lab, idx) => {
      const pageIndex = Math.floor(idx / perPage);
      const pos = idx % perPage;
      const r = Math.floor(pos / COLS);
      const c = pos % COLS;

      if (pos === 0 && pageIndex > 0) doc.addPage();

      const x0 = PAGE_MARGIN + c * (cellW + GAP);
      const y0 = PAGE_MARGIN + r * (cellH + GAP);

      // —Ä–∞–º–∫–∞ –∫–æ–º—ñ—Ä–∫–∏
      doc.rect(x0, y0, cellW, cellH);
      // –ª—ñ–Ω—ñ—è –º—ñ–∂ –≤–µ—Ä—Ö–Ω—ñ–º —Ç–∞ –Ω–∏–∂–Ω—ñ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏
      doc.line(x0, y0 + ID_BAND_H, x0 + cellW, y0 + ID_BAND_H);

      // –í–µ—Ä—Ö–Ω—ñ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: ID (–ø–æ —Ü–µ–Ω—Ç—Ä—É)
      drawCenteredBlock(x0, y0, cellW, ID_BAND_H, lab.id);

      // –ù–∏–∂–Ω—ñ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: –Ω–∞–∑–≤–∞ (–ø–æ —Ü–µ–Ω—Ç—Ä—É)
      drawCenteredBlock(x0, y0 + ID_BAND_H, cellW, cellH - ID_BAND_H, lab.name);
    });

    doc.save("etykiety.pdf");
  };

  const confirmGen = async () => {
    // –∑–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É –ø–∞—Ä–∞–º–µ—Ç—Ä—ñ–≤ —ñ –ø–æ–∫–∞–∑—É—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä
    setGenModal((s) => ({ ...s, open: false }));
    setGenProgress({ open: true, pct: 1, text: "Przygotowywanie‚Ä¶" });

    // ¬´—Ñ–µ–π–∫–æ–≤–∏–π¬ª –ø—Ä–æ–≥—Ä–µ—Å –¥–æ 90%, —â–æ–± –±—É–ª–æ –≤–∏–¥–Ω–æ —Ä—É—Ö
    if (genProgTimerRef.current) clearInterval(genProgTimerRef.current);
    genProgTimerRef.current = setInterval(() => {
      setGenProgress((p) => {
        const next = Math.min(90, p.pct + 1.5); // +1.5% –∫–æ–∂–Ω—ñ 300–º—Å
        return { ...p, pct: next };
      });
    }, 300);

    try {
      await postForDownload(
        api("/gen/from-clients"),
        {
          clientIds: checkedIds,
          ids: checkedIds,
          issueDate: genModal.issueDate,
          month: genModal.month,
          mode: tab,
        },
        "faktury.zip"
      );

      // —É—Å–ø—ñ—Ö ‚Üí –¥–æ–±–∏–≤–∞—î–º–æ –¥–æ 100% —ñ –∑–∞–∫—Ä–∏–≤–∞—î–º–æ
      if (genProgTimerRef.current) clearInterval(genProgTimerRef.current);
      setGenProgress({ open: true, pct: 100, text: "Gotowe ‚úî" });

      setTimeout(() => {
        setGenProgress({ open: false, pct: 0, text: "" });
        setGenModal({
          open: false,
          issueDate: todayISO(),
          month:
            settings.currentIssueMonth || new Date().toISOString().slice(0, 7),
        });
        alert("‚úÖ Wygenerowano paczkƒô faktur (ZIP) i pobrano plik.");
      }, 600);
    } catch (e) {
      if (genProgTimerRef.current) clearInterval(genProgTimerRef.current);
      setGenProgress({ open: false, pct: 0, text: "" });
      alert(`‚ùå ${e.message || "B≈ÇƒÖd generowania faktur."}`);
    }
  };

  const handleSelectClient = (c) => {
    setScrollYBeforeOpen(window.scrollY || window.pageYOffset || 0);
    setSelectedClient(c);
  };

  const handleBackFromCard = () => {
    setSelectedClient(null);
    setTimeout(() => {
      window.scrollTo(0, scrollYBeforeOpen || 0);
    }, 0);
  };

  const toggleArchiveSelected = async () => {
    if (!selectedClient) return;
    const id = getId(selectedClient);
    const today = new Date().toISOString().slice(0, 10);

    const updated = clients.map((c) => {
      if (getId(c) !== id) return c;
      const nextArchived = !Boolean(c.archived);
      return {
        ...c,
        archived: nextArchived,
        archivedAt: nextArchived ? today : null,
      };
    });

    const nextSel = updated.find((c) => getId(c) === id) || null;
    setClients(updated);
    setSelectedClient(nextSel);
    try {
      await fetch(api("/save-clients"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updated),
      });
    } catch {}
  };

  return (
    <div className="space-y-4">
      {/* –®–∞–ø–∫–∞ –±–µ–∑ –¥—É–±–ª—é—é—á–∏—Ö –∫–Ω–æ–ø–æ–∫ —Ä–µ–∂–∏–º—É */}
      <div className="card-lg border-2 border-blue-200 bg-blue-50/60">
        <div className="flex items-center justify-between gap-3 flex-wrap">
          <h1 className="text-2xl font-bold">
            {pageTitle || "üìí Baza klient√≥w"}
          </h1>
          {!forceArchivedView && (
            <label className="inline-flex items-center gap-2 text-sm">
              <input
                type="checkbox"
                checked={showArchived}
                onChange={(e) => setShowArchived(e.target.checked)}
              />
              Poka≈º archiwum
            </label>
          )}
        </div>

        {/* –ü–æ—à—É–∫/—Ñ—ñ–ª—å—Ç—Ä–∏/—ñ–º–ø–æ—Ä—Ç/–¥–æ–¥–∞—Ç–∏ */}
        <div className="mt-3 flex items-center gap-2 flex-wrap">
          <input
            type="search"
            placeholder="Szukaj klienta‚Ä¶"
            className="input w-60"
            value={q}
            onChange={(e) => setQ(e.target.value)}
          />
          {tab === "abonament" && (
            <input
              type="search"
              placeholder="Filtr abonamentu‚Ä¶"
              className="input w-52"
              value={abonFilter}
              onChange={(e) => setAbonFilter(e.target.value)}
              title="Filtruj po nazwie abonamentu"
            />
          )}
          <label className="btn-secondary cursor-pointer">
            Za≈Çaduj Excel (
            {forcedMode === "perpiece" ? "Na sztuki" : "Abonament"})
            <input
              type="file"
              accept=".xlsx,.xls"
              onChange={handleFileUpload}
              hidden
            />
          </label>
          <button className="btn-primary" onClick={startAdd}>
            {showAdd ? "Anuluj" : "Dodaj klienta"}
          </button>

          {/* –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∑ –±–∞–∑–∏ + –ì–†–£–ü–û–í–ê –ê–†–•–Ü–í–Ü–ó–ê–¶–Ü–Ø */}
          <div className="ml-auto flex items-center gap-2">
            <button
              className="btn-secondary"
              onClick={bulkDelete}
              disabled={!checkedIds.length}
              title="Przenie≈õ zaznaczonych klient√≥w do archiwum"
            >
              Archiwizuj zaznaczone
            </button>
            <button
              className="btn-primary"
              onClick={openGen}
              disabled={!checkedIds.length}
              title="Generuj faktury z zaznaczonych klient√≥w"
            >
              üßæ Generuj faktury
            </button>
            <button
              className="btn-primary"
              onClick={openKartoteka}
              title="Generuj PDF kartoteki klient√≥w abonamentowych"
            >
              üìÑ Generuj kartotekƒô
            </button>

            <button
              className="btn-primary"
              onClick={generateLabelsPDF}
              title="Generuj PDF z etykietami (3√ó7 na A4)"
            >
              üè∑Ô∏è Generuj etykiety
            </button>
          </div>
        </div>
        {/* === –°–¢–†–Ü–ß–ö–ê-–ü–ï–†–ï–ú–ò–ö–ê–ß (–ø–æ–≤–Ω–∞ —à–∏—Ä–∏–Ω–∞ –ü–Ü–î —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏) === */}
        {!hideModeSwitcher && (
          <div className="mt-3">
            <div className="w-full grid grid-cols-2 rounded-xl overflow-hidden border-2 border-blue-300 text-center select-none">
              <button
                type="button"
                className={
                  "py-3 font-semibold transition " +
                  (tab === "abonament"
                    ? "bg-blue-600 text-white"
                    : "bg-white text-blue-700 hover:bg-blue-50")
                }
                onClick={() => switchTab("abonament")}
                title="Klienci z abonamentem"
              >
                Abonament
              </button>
              <button
                type="button"
                className={
                  "py-3 font-semibold transition " +
                  (tab === "perpiece"
                    ? "bg-blue-600 text-white"
                    : "bg-white text-blue-700 hover:bg-blue-50")
                }
                onClick={() => switchTab("perpiece")}
                title="Klienci rozliczani na sztuki"
              >
                Na sztuki
              </button>
            </div>
          </div>
        )}
      </div>

      {showAdd && (
        <form onSubmit={handleSubmit} className="card-lg space-y-3">
          <div className="grid md:grid-cols-2 gap-3">
            <div>
              <label className="block text-sm mb-1">ID</label>
              <input
                className="input w-full"
                value={formClient.id}
                onChange={(e) =>
                  setFormClient({ ...formClient, id: e.target.value })
                }
                placeholder="Unikalny identyfikator (z Excel: kolumna ID)"
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Nazwa *</label>
              <input
                className="input w-full"
                value={formClient.name}
                onChange={(e) =>
                  setFormClient({ ...formClient, name: e.target.value })
                }
                required
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Email</label>
              <input
                type="email"
                className="input w-full"
                value={formClient.email}
                onChange={(e) =>
                  setFormClient({ ...formClient, email: e.target.value })
                }
              />
            </div>
            <div>
              <label className="block text-sm mb-1">Telefon</label>
              <input
                className="input w-full"
                value={formClient.phone}
                onChange={(e) =>
                  setFormClient({ ...formClient, phone: e.target.value })
                }
              />
            </div>
            <div>
              <label className="block text-sm mb-1">Adres</label>
              <input
                className="input w-full"
                value={formClient.address}
                onChange={(e) =>
                  setFormClient({ ...formClient, address: e.target.value })
                }
              />
            </div>

            <div>
              <label className="block text-sm mb-1">Typ</label>
              <select
                className="input w-full"
                value={formClient.type}
                onChange={(e) =>
                  setFormClient({ ...formClient, type: e.target.value })
                }
              >
                <option value="op">Osoba prywatna</option>
                <option value="firma">Firma</option>
              </select>
            </div>

            {/* ‚ñº‚ñº‚ñº –¢–£–¢: –æ–±–æ–≤'—è–∑–∫–æ–≤–µ –ø–æ–ª–µ "Logistyka" ‚ñº‚ñº‚ñº */}
            <div>
              <label className="block text-sm mb-1">Logistyka *</label>
              <select
                className="input w-full"
                value={formClient.logistics}
                onChange={(e) =>
                  setFormClient({ ...formClient, logistics: e.target.value })
                }
                required
              >
                {LOGI_OPTIONS.map((opt) => (
                  <option key={opt.value} value={opt.value}>
                    {opt.label}
                  </option>
                ))}
              </select>
            </div>
            {/* ‚ñ≤‚ñ≤‚ñ≤ –ö–Ü–ù–ï–¶–¨ –±–ª–æ–∫—É –ª–æ–≥—ñ—Å—Ç–∏–∫–∏ ‚ñ≤‚ñ≤‚ñ≤ */}

            {formClient.type === "firma" ? (
              <div>
                <label className="block text-sm mb-1">NIP</label>
                <input
                  className="input w-full"
                  value={formClient.nip}
                  onChange={(e) =>
                    setFormClient({ ...formClient, nip: e.target.value })
                  }
                />
              </div>
            ) : (
              <div>
                <label className="block text-sm mb-1">PESEL</label>
                <input
                  className="input w-full"
                  value={formClient.pesel}
                  onChange={(e) =>
                    setFormClient({ ...formClient, pesel: e.target.value })
                  }
                />
              </div>
            )}

            <div>
              <label className="block text-sm mb-1">Abonament</label>
              <select
                className="input w-full"
                value={formClient.subscription}
                onChange={(e) =>
                  setFormClient({ ...formClient, subscription: e.target.value })
                }
              >
                <option value="">‚Äî brak (na sztuki) ‚Äî</option>
                {SUBSCRIPTIONS.map((name) => (
                  <option key={name} value={name}>
                    {name}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm mb-1">Kwota abonamentu</label>
              <input
                type="number"
                step="0.01"
                min="0"
                className="input w-full"
                value={formClient.subscriptionAmount}
                onChange={(e) =>
                  setFormClient({
                    ...formClient,
                    subscriptionAmount: e.target.value,
                  })
                }
              />
            </div>

            <div>
              <label className="block text-sm mb-1">
                Data podpisania umowy
              </label>
              <input
                type="date"
                className="input w-full"
                value={formClient.agreementStart}
                onChange={(e) => {
                  const startISO = normalizeExcelDate(e.target.value);
                  setFormClient({
                    ...formClient,
                    agreementStart: startISO,
                    agreementEnd: startISO ? addMonths(startISO, 6) : "",
                  });
                }}
              />
            </div>
            <div>
              <label className="block text-sm mb-1">ObowiƒÖzuje do</label>
              <input
                type="date"
                className="input w-full"
                value={formClient.agreementEnd}
                onChange={(e) =>
                  setFormClient({
                    ...formClient,
                    agreementEnd: normalizeExcelDate(e.target.value),
                  })
                }
              />
            </div>

            <input
              type="hidden"
              value={formClient.billingMode}
              readOnly
              aria-hidden="true"
            />
          </div>

          <div className="pt-2 flex gap-2">
            <button type="submit" className="btn-primary">
              {editIndex !== null ? "Zapisz zmiany" : "Zapisz klienta"}
            </button>
            {editIndex !== null && (
              <button
                type="button"
                className="btn-secondary"
                onClick={() => {
                  setShowAdd(false);
                  setEditIndex(null);
                  setFormClient({ ...emptyClient, billingMode: tab });
                }}
              >
                Anuluj
              </button>
            )}
          </div>
        </form>
      )}

      {!selectedClient ? (
        <div className="card-lg overflow-x-hidden">
          <ClientList
            clients={filtered}
            onSelect={handleSelectClient}
            onEdit={startEdit}
            onDeleteRequest={askDelete}
            selectable
            checkedIds={checkedIds}
            onToggleCheck={onToggleCheck}
            onToggleCheckAll={onToggleCheckAll}
            showAbonFields={forcedMode === "abonament" || forcedMode === "all"}
            plainContacts
            showIdBeforeName={forcedMode === "perpiece"}
            idCellMaxChars={13}
            logisticsLabelMap={LOGI_LABEL}
            showLogistics
          />
        </div>
      ) : (
        <div className="card-lg">
          <ClientCard
            client={selectedClient}
            onBack={handleBackFromCard}
            onSetNotice={() => handleSetNotice(selectedClient)}
            onCancelNotice={() => handleCancelNotice(selectedClient)}
            onUpdate={handleUpdateClient}
            protocols={clientProtocols.list}
            protocolsLoading={clientProtocols.loading}
            protocolsReadOnly
            protocolsTabLabel="Protoko≈Çy"
            onToggleArchive={toggleArchiveSelected}
            logisticsLabelMap={LOGI_LABEL}
          />
        </div>
      )}

      {/* –ú–æ–¥–∞–ª–∫–∞ –∞—Ä—Ö—ñ–≤–∞—Ü—ñ—ó (–∑–∞–º—ñ—Å—Ç—å –≤–∏–¥–∞–ª–µ–Ω–Ω—è) */}
      <Modal
        open={confirmOpen}
        title="Przenie≈õƒá klienta do archiwum?"
        onClose={() => {
          setConfirmOpen(false);
          setClientToDelete(null);
        }}
        onConfirm={confirmDelete}
        confirmText="Archiwizuj"
        cancelText="Anuluj"
      >
        {clientToDelete ? (
          <p>
            Czy na pewno chcesz przenie≈õƒá klienta{" "}
            <span className="font-semibold">{clientToDelete.name || "?"}</span>{" "}
            do archiwum? Dane pozostanƒÖ dostƒôpne w widoku archiwum.
          </p>
        ) : null}
      </Modal>

      {/* –ú–æ–¥–∞–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –∑ –±–∞–∑–∏ */}
      <Modal
        open={genModal.open}
        title="Generuj faktury z zaznaczonych"
        onClose={() =>
          setGenModal({
            open: false,
            issueDate: todayISO(),
            month:
              settings.currentIssueMonth ||
              new Date().toISOString().slice(0, 7),
          })
        }
        onConfirm={confirmGen}
        confirmText="Generuj"
        cancelText="Anuluj"
      >
        <div className="space-y-2">
          <div className="text-sm">Wybrano klient√≥w: {checkedIds.length}</div>

          <label className="block text-sm">Data wystawienia</label>
          <input
            type="date"
            className="input w-full"
            value={genModal.issueDate}
            onChange={(e) =>
              setGenModal((s) => ({ ...s, issueDate: e.target.value }))
            }
          />

          <label className="block text-sm mt-2">MiesiƒÖc rozliczeniowy</label>
          <input
            type="month"
            className="input w-full"
            value={genModal.month}
            onChange={(e) =>
              setGenModal((s) => ({ ...s, month: e.target.value }))
            }
          />
        </div>
      </Modal>

      {/* –Ü–Ω—Ñ–æ –ø—Ä–æ –ø—Ä–æ–≥—Ä–µ—Å –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó */}
      {genProgress.open && (
        <div className="fixed inset-0 bg-black/30 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-lg p-6 w-full max-w-md">
            <div className="text-lg font-semibold mb-3">
              Generowanie faktur‚Ä¶
            </div>
            <div className="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
              <div
                className="h-full bg-blue-600 transition-all duration-200"
                style={{ width: `${genProgress.pct}%` }}
              />
            </div>
            <div className="mt-2 text-sm text-gray-700">
              {genProgress.text || `${Math.round(genProgress.pct)}%`}
            </div>
            <div className="mt-2 text-xs text-gray-500">
              Nie zamykaj tej karty do zako≈Ñczenia generowania.
            </div>
          </div>
        </div>
      )}

      {/* –Ü–Ω—Ñ–æ –ø—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞ */}
      {addedInfo.open && (
        <div className="fixed inset-0 bg-black/30 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-lg p-6 w_full max-w-md text-center">
            <div className="text-lg font-semibold mb-2">‚úÖ Klient dodany</div>
            <div className="text-sm text-gray-700 mb-4">
              {addedInfo.name
                ? `Klient "${addedInfo.name}" zosta≈Ç pomy≈õlnie zapisany.`
                : "Zapisano klienta."}
            </div>
            <button
              className="btn-primary"
              onClick={() => setAddedInfo({ open: false, name: "" })}
            >
              OK
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
